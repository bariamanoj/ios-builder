name: iOS Pricing and Availability Only

on:
  workflow_dispatch:
    inputs:
      bundle_identifier:
        description: 'Bundle identifier (e.g., com.company.app)'
        required: true
        type: string
        default: 'com.san.mainAp'

jobs:
  configure-pricing:
    runs-on: macos-latest
    
    steps:
    - name: Checkout ios-builder (latest)
      uses: actions/checkout@v4
      with:
        repository: bariamanoj/ios-builder
        token: ${{ secrets.GH_TOKEN }}
        ref: main
        fetch-depth: 1
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    
    - name: Install Dependencies
      run: |
        gem install fastlane spaceship
        bundle install
    
    - name: Verify Latest Code
      run: |
        echo "üìã Current commit:"
        git log -1 --oneline
        echo "üìÅ Fastfile updated:"
        grep -n "app_prices = app.prices" fastlane/Fastfile || echo "‚úÖ Using updated pricing code"
    
    - name: Configure App Store Pricing and Availability ONLY
      run: |
        echo "üí∞ Configuring App Store pricing and availability..."
        echo "üÜî Bundle: ${{ github.event.inputs.bundle_identifier }}"
        echo "üîß Using produce action for pricing configuration"
        
        # Use produce action which is more reliable for pricing
        fastlane run produce \
          app_identifier:"${{ github.event.inputs.bundle_identifier }}" \
          price_tier:0 \
          skip_itc:true \
          skip_devcenter:true
        
        echo "‚úÖ Pricing configuration completed"
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
