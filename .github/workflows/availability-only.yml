name: iOS App Availability Setup Only

on:
  workflow_dispatch:
    inputs:
      app_id:
        description: 'App Store Connect App ID'
        required: true
        type: string
        default: '6753968771'

jobs:
  setup-availability:
    runs-on: macos-latest
    
    steps:
    - name: Setup App Availability Worldwide
      run: |
        echo "üåç Setting up worldwide app availability..."
        echo "üì± App ID: ${{ github.event.inputs.app_id }}"
        
        # Install fastlane
        gem install fastlane --user-install
        export PATH="$HOME/.local/share/gem/ruby/3.3.0/bin:$PATH"
        
        # Create fastlane directory and Fastfile
        mkdir -p fastlane
        cat > fastlane/Fastfile << 'EOF'
        default_platform(:ios)
        
        platform :ios do
          desc "Setup app availability worldwide"
          lane :setup_availability do |options|
            app_id = options[:app_id]
            
            # Setup API key
            app_store_connect_api_key(
              key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
              issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
              key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
            )
            
            UI.message("üîç Finding app with ID: #{app_id}")
            
            begin
              # Get the app
              app = Spaceship::ConnectAPI::App.get(app_id: app_id)
              
              if app.nil?
                UI.error("‚ùå App not found with ID: #{app_id}")
                next
              end
              
              UI.message("üì± Found app: #{app.name}")
              UI.message("üöÄ Setting app to be available worldwide...")
              
              # Direct approach to set up app availability using the correct API
              begin
                UI.message("üîÑ Setting up app availability directly...")
                
                # Get all territories
                territories = Spaceship::ConnectAPI::Territory.all
                territory_ids = territories.map(&:id)
                UI.message("üåç Found #{territory_ids.count} territories")
                
                # Use direct API call to create app availability
                require 'net/http'
                require 'json'
                
                # Get the API token from Spaceship
                token = Spaceship::ConnectAPI.token.text
                
                # Create app availability with all territories
                uri = URI("https://api.appstoreconnect.apple.com/v2/appAvailabilities")
                http = Net::HTTP.new(uri.host, uri.port)
                http.use_ssl = true
                
                request = Net::HTTP::Post.new(uri)
                request['Authorization'] = "Bearer #{token}"
                request['Content-Type'] = 'application/json'
                
                # Create availability payload with all territories using correct v2 format
                payload = {
                  data: {
                    type: 'appAvailabilities',
                    attributes: {
                      availableInNewTerritories: true
                    },
                    relationships: {
                      app: {
                        data: { type: 'apps', id: app.id }
                      },
                      territoryAvailabilities: {
                        data: territory_ids.map do |id| 
                          { type: 'territoryAvailabilities', id: id }
                        end
                      }
                    }
                  },
                  included: territory_ids.map do |id|
                    {
                      type: 'territoryAvailabilities',
                      id: id,
                      attributes: {
                        available: true
                      }
                    }
                  end
                }
                
                request.body = payload.to_json
                response = http.request(request)
                
                if response.code == '201'
                  UI.success("‚úÖ Successfully created app availability for all #{territory_ids.count} territories!")
                  UI.message("üéâ Your app is now available worldwide!")
                elsif response.code == '409'
                  UI.message("üìä App availability already exists, this is expected")
                  UI.success("‚úÖ App should now be available in #{territory_ids.count} territories!")
                else
                  UI.error("‚ùå API call failed: #{response.code}")
                  UI.message("Response: #{response.body}")
                end
                    {
                      type: 'territoryAvailabilities',
                      id: id,
                      attributes: {
                        available: true
                      }
                    }
                  }
                }
                
                request.body = payload.to_json
                response = http.request(request)
                
                if response.code == '201'
                  UI.success("‚úÖ Successfully created app availability for all #{territory_ids.count} territories!")
                  UI.message("üéâ Your app is now available worldwide!")
                else
                  UI.error("‚ùå API call failed: #{response.code}")
                  UI.message("Response: #{response.body}")
                  UI.message("üí° You'll need to click 'Set Up Availability' manually in App Store Connect")
                end
                
              rescue => availability_error
                UI.error("‚ùå Availability setup failed: #{availability_error.message}")
                UI.message("üí° Manual setup required:")
                UI.message("   1. Go to App Store Connect > ManzTestApp2025 > Pricing and Availability")
                UI.message("   2. Click 'Set Up Availability' button")
                UI.message("   3. Select 'All Countries and Regions'")
                UI.message("   4. Click 'Save'")
              end
              
            rescue => e
              UI.error("‚ùå Error: #{e.message}")
              UI.message("üí° This may require manual setup in App Store Connect")
            end
          end
        end
        EOF
        
        # Run fastlane with explicit lane
        cd fastlane && fastlane setup_availability app_id:${{ github.event.inputs.app_id }}
      env:
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
