name: iOS Auto Build and Deploy

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL'
        required: true
        type: string
      app_name:
        description: 'App name for App Store'
        required: true
        type: string
      bundle_identifier:
        description: 'Bundle identifier'
        required: true
        type: string
      contact_first_name:
        description: 'Contact First Name'
        required: true
        type: string
      contact_last_name:
        description: 'Contact Last Name'
        required: true
        type: string
      contact_phone:
        description: 'Contact Phone Number'
        required: true
        type: string
      contact_email:
        description: 'Contact Email'
        required: true
        type: string
      app_description:
        description: 'App Description'
        required: true
        type: string
      support_url:
        description: 'Support/Marketing URL'
        required: true
        type: string
      privacy_policy_url:
        description: 'Privacy Policy URL'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest

    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.repo_url || 'bariamanoj/NewAppSample' }}
        token: ${{ secrets.GH_TOKEN }}

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    - name: Install Fastlane
      run: gem install fastlane

    - name: Build and Setup App Store
      run: |
        echo "Building ${{ github.event.inputs.app_name }} v1.1 for App Store distribution"

        mkdir -p fastlane
        cat > fastlane/Fastfile << 'EOF'
        default_platform(:ios)

        platform :ios do
          desc "Build with Fastlane automatic provisioning"
          lane :build_and_sign do
            app_store_connect_api_key(
              key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
              issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
              key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
              duration: 1200,
              in_house: false
            )

            create_keychain(
              name: "fastlane_tmp_keychain",
              password: "temppassword123",
              default_keychain: true,
              unlock: true,
              timeout: 3600,
              lock_when_sleeps: false
            )

            match(
              type: "appstore",
              app_identifier: "com.san.mainAp",
              git_url: "https://github.com/bariamanoj/ios-certificates-new",
              username: "dohrasanket@gmail.com",
              team_id: "42FLQUC3A9",
              readonly: false,
              keychain_name: "fastlane_tmp_keychain",
              keychain_password: "temppassword123"
            )

            update_project_provisioning(
              xcodeproj: "NewAppSample.xcodeproj",
              target_filter: "NewAppSample",
              profile: ENV["sigh_com.san.mainAp_appstore_profile-path"],
              code_signing_identity: "iPhone Distribution"
            )

            gym(
              configuration: "Release",
              export_method: "app-store",
              sdk: "iphoneos",
              export_options: {
                method: "app-store",
                teamID: "42FLQUC3A9",
                uploadBitcode: false,
                uploadSymbols: true,
                signingStyle: "manual"
              },
              output_directory: "./build/ipa",
              output_name: "${{ github.event.inputs.app_name }}_v1.1.ipa",
              archive_path: "./build/archive/${{ github.event.inputs.app_name }}_v1.1.xcarchive"
            )
          end
        end
        EOF

        fastlane build_and_sign
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: "xzwz-wtfs-wptw-bhhe"
        MATCH_PASSWORD: "Welcome123"
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-${{ github.event.inputs.app_name || 'ManzTestApp2025' }}
        path: build/
        if-no-files-found: warn

    - name: Upload to App Store & Set Free + All Territories
      run: |
        echo "Uploading IPA and configuring pricing & availability..."

        IPA_FILE=$(find build/ipa -name "*.ipa" | head -1)

        if [ -n "$IPA_FILE" ]; then
          echo "Found IPA: $IPA_FILE"

          # Upload to TestFlight
          fastlane run pilot upload \
            ipa:"$IPA_FILE" \
            username:"${{ github.event.inputs.contact_email }}" \
            app_identifier:"com.san.mainAp" \
            skip_waiting_for_build_processing:true

          echo "IPA uploaded to TestFlight!"

          # Upload metadata
          fastlane run deliver \
            username:"${{ github.event.inputs.contact_email }}" \
            app_identifier:"com.san.mainAp" \
            skip_binary_upload:true \
            skip_screenshots:true \
            force:true \
            description:"{\"en-US\":\"${{ github.event.inputs.app_description }}\"}" \
            name:"{\"en-US\":\"${{ github.event.inputs.app_name }}\"}" \
            keywords:"{\"en-US\":\"utility, free, app\"}" \
            copyright:"Â© 2025 ${{ github.event.inputs.app_name }}" \
            marketing_url:"{\"en-US\":\"${{ github.event.inputs.support_url }}\"}" \
            privacy_url:"{\"en-US\":\"${{ github.event.inputs.privacy_policy_url }}\"}" \
            support_url:"{\"en-US\":\"${{ github.event.inputs.support_url }}\"}" \
            primary_category:"UTILITIES" \
            app_review_information:"{\"first_name\":\"${{ github.event.inputs.contact_first_name }}\",\"last_name\":\"${{ github.event.inputs.contact_last_name }}\",\"phone_number\":\"${{ github.event.inputs.contact_phone }}\",\"email_address\":\"${{ github.event.inputs.contact_email }}\",\"notes\":\"Contact for ${{ github.event.inputs.app_name }}\"}" \
            submission_information:"{\"add_id_info_uses_idfa\":false,\"content_rights_has_rights\":true,\"export_compliance_uses_encryption\":false,\"export_compliance_is_exempt\":true,\"export_compliance_contains_third_party_cryptography\":false,\"export_compliance_contains_proprietary_cryptography\":false,\"export_compliance_available_on_french_store\":true}"

          echo "Metadata uploaded successfully!"

          # ==== SET FREE IN ALL TERRITORIES ====
          ruby - <<'RUBY'
          require 'spaceship'

          Spaceship::ConnectAPI.token = Spaceship::ConnectAPI::Token.create(
            key_id: ENV['APP_STORE_CONNECT_API_KEY_KEY_ID'],
            issuer_id: ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
            key: ENV['APP_STORE_CONNECT_API_KEY_KEY']
          )

          app = Spaceship::ConnectAPI::App.find('com.san.mainAp')
          abort "App not found!" unless app
          puts "Found app: #{app.name} (#{app.id})"

          # ---- Price schedule (relationship is `prices`) ----
          price_schedule_resp = app.get_app_price_schedule   # returns a single AppPriceSchedule
          price_schedule = price_schedule_resp.first

          unless price_schedule
            puts "Creating new price schedule..."
            base_territory = Spaceship::ConnectAPI::Territory.all.find { |t| t.currency == 'USD' }
            price_schedule = app.create_app_price_schedule(base_territory_id: base_territory.id)
          else
            puts "Using existing price schedule."
          end

          # ---- Free tier (Tier 0) ----
          free_tier = Spaceship::ConnectAPI::AppPriceTier.all.find { |t| t.price == 0.0 }
          abort "Free tier not found!" unless free_tier
          puts "Using Free Tier: #{free_tier.tier_stem}"

          # ---- All territories ----
          territories = Spaceship::ConnectAPI::Territory.all
          puts "Found #{territories.count} territories"

          # ---- Build manual prices ----
          manual_prices = territories.map do |t|
            { territory_id: t.id, price_tier_id: free_tier.id }
          end

          # ---- Patch the schedule ----
          price_schedule.patch(manual_prices: manual_prices)

          puts "SUCCESS: App is now FREE in ALL #{territories.count} territories!"
RUBY

        else
          echo "ERROR: No IPA file found in build/ipa/"
          exit 1
        fi
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: "xzwz-wtfs-wptw-bhhe"
        MATCH_PASSWORD: "Welcome123"
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}

    - name: Upload App Privacy Details
      run: |
        fastlane run upload_app_privacy_details_to_app_store \
          username:"${{ github.event.inputs.contact_email }}" \
          team_name:"Sanket Dohra" \
          app_identifier:"com.san.mainAp" \
          json_path:"./privacy_data.json"
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: "xzwz-wtfs-wptw-bhhe"
        MATCH_PASSWORD: "Welcome123"
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
# Updated Thu Nov  6 15:39:17 IST 2025
