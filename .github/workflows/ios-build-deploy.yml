name: iOS Auto Build and Deploy

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL'
        required: true
        type: string
      app_name:
        description: 'App name for App Store'
        required: true
        type: string
      bundle_identifier:
        description: 'Bundle identifier (e.g., com.company.app)'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.repo_url }}
        token: ${{ secrets.GH_TOKEN }}
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    
    - name: Install Fastlane
      run: gem install fastlane
    
    - name: Setup API Key
      run: |
        mkdir -p ~/.appstoreconnect/private_keys/
        echo "${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}.p8
        
        # Set up API key for Fastlane
        if [ -n "${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}" ]; then
          export FASTLANE_API_KEY_PATH="~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}.p8"
          export APP_STORE_CONNECT_API_KEY_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}"
          export APP_STORE_CONNECT_API_KEY_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}"
        fi
    
    - name: Create App on App Store Connect
      run: |
        echo "üçé Creating app on App Store Connect"
        
        # Use session token authentication (no 2FA needed)
        fastlane run produce \
          app_name:"${{ github.event.inputs.app_name }}" \
          app_identifier:"${{ github.event.inputs.bundle_identifier }}" \
          language:"en-US" \
          app_version:"1.0" \
          sku:"$(echo "${{ github.event.inputs.bundle_identifier }}" | sed 's/\./-/g')-$(date +%s)" \
          skip_itc:false \
          skip_devcenter:false
      env:
        FASTLANE_SESSION: '---
- !ruby/object:HTTP::Cookie
  name: myacinfo
  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d3c240e5c432b5bf1f36da31bb243b5a6f6b19588183d854124812c0fff9049ef97c3bd29005797633c7fb29e0457e3f551626cc314b29ecae3bf6755abae3957bb22b3c07eaae22c2da5ab3d1c18e04f7ff609e27e63187702d70ae61258f4891a2e99c018899b57801e8978ef70ad521afacfee86fbbdcd7ade8d85eb9094d225bc7b2a9531ca2a87da8580c2f4605d00b0938bc7c4608899ca5128a0d0dc4ee77508a90d6fc87d040c5a2b1592299e55b800f0fa83756b453ec6e617a7419c06c2e7c974a90fb318bf065e04754dd10c9344970c67237b7fbb46f4dab2f931ab63e5755219c60f2c165ed5f55f14d9e068dc988238f883652aa9ed9efa1141251b0704719658eb7fe12c02b73c32f51d67d57da5946380358b953a082fdfb766eb43f539b7ca29f0da78353a09c1d2d717ad22484c3a49edae56239b16b2ada5ced3f13369f5fddca8ed09790531956bc43efbbf059c292f0bb199bdb61a511c05a4b8653ab9acd772eb22dd8add810de2543c835a683978421e977d92570d5d3c1b968d65e51ebbda86a98fdf3d00fec4de5a88104576b8be34569f7c594299e3c766189ea1232a9a733d907eb2907fb07f71b978087358dcfd65187ce898532090f72015e1e6ff2507bfc4387dfab4e2d63b487b894fc54c27d74e23ea3f6e905cba2a826858e8f625a09139f6f94c20cb74d4543601d800259ad7fc6e293585a47V3
  domain: apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires:
  max_age:
  created_at: 2025-10-13 10:33:23.730297000 +05:30
  accessed_at: 2025-10-13 14:17:51.627228000 +05:30
- !ruby/object:HTTP::Cookie
  name: DES521e216212c21f11a57fea7444394ae78
  value: HSARMTKNSRVXWFlaT2xBLF+Quc4blkCklk9hmyJARkstbGcBSuzM9C1BydSr5uYzKaWm5qX+VzcW7nRHSOXOegc3ZXJG+6vIg8ERyLZLOR5ZsOwVzwt/QfKVHUK8LlN0tCsXfp4ah+TKi73ddCfmY3dEFonCJ/BUwLOhipg78JXJUjtzZLIqXU0b1e31YWqFDw==SRVX
  domain: idmsa.apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires:
  max_age: 2592000
  created_at: 2025-10-10 11:30:12.666718000 +05:30
  accessed_at: 2025-10-13 10:33:21.039345000 +05:30
- !ruby/object:HTTP::Cookie
  name: dqsid
  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3NjAzNDUyNzEsImp0aSI6IlpSR01DYnNQWC1mVi1VRjFYcldtc3cifQ.jnN9TGWKbm_J93JWDzykZ_UHxWwWjkNkP3JD7YLwnfc
  domain: appstoreconnect.apple.com
  for_domain: false
  path: "/"
  secure: true
  httponly: true
  expires:
  max_age: 1800
  created_at: &1 2025-10-13 14:17:52.929326000 +05:30
  accessed_at: *1'
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
      continue-on-error: true
    
    - name: Build and Create Archive
      run: |
        echo "üöÄ Creating iOS Archive"
        echo "üì¶ App: ${{ github.event.inputs.app_name }}"
        echo "üÜî Bundle: ${{ github.event.inputs.bundle_identifier }}"
        
        # Find project
        if find . -maxdepth 1 -name "*.xcworkspace" -type d | grep -q .; then
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1 | sed 's|^\./||')
          SCHEME=$(basename "$WORKSPACE" .xcworkspace)
          echo "üì± Archiving workspace: $WORKSPACE"
          
          xcodebuild -workspace "$WORKSPACE" \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath "build/$SCHEME.xcarchive" \
                     CODE_SIGNING_ALLOWED=NO \
                     archive
            
        elif find . -maxdepth 1 -name "*.xcodeproj" -type d | grep -q .; then
          PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1 | sed 's|^\./||')
          SCHEME=$(basename "$PROJECT" .xcodeproj)
          echo "üì± Archiving project: $PROJECT"
          
          xcodebuild -project "$PROJECT" \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath "build/$SCHEME.xcarchive" \
                     CODE_SIGNING_ALLOWED=NO \
                     archive
        fi
        
        echo "‚úÖ Archive created successfully!"
        ls -la build/
      env:
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
    
    - name: Export IPA (Unsigned)
      run: |
        echo "üì¶ Exporting IPA"
        
        # Find archive
        ARCHIVE=$(find build -name "*.xcarchive" | head -1)
        if [ -n "$ARCHIVE" ]; then
          echo "üì± Exporting from: $ARCHIVE"
          
          # Create IPA manually
          mkdir -p build/ipa
          
          # Extract app bundle from archive
          find "$ARCHIVE/Products/Applications" -name "*.app" -exec cp -r {} build/ipa/ \;
          
          # Create IPA with proper naming
          cd build/ipa
          APP_FILE=$(find . -name "*.app" -type d | head -1 | sed 's|^\./||')
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -n "$APP_FILE" ]; then
            mkdir -p Payload
            mv "$APP_FILE" Payload/
            zip -r "$APP_NAME.ipa" Payload/
            rm -rf Payload/
            
            echo "‚úÖ IPA created successfully!"
            ls -la *.ipa
          else
            echo "‚ùå No .app bundle found"
          fi
        else
          echo "‚ùå No archive found to export"
        fi
      continue-on-error: true
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-${{ github.event.inputs.app_name }}
        path: |
          build/
        if-no-files-found: warn
    
    - name: Upload to App Store Connect (Optional)
      run: |
        echo "üöÄ Attempting to upload to App Store Connect"
        
        # Find the IPA file
        IPA_FILE=$(find build/ipa -name "*.ipa" | head -1)
        
        if [ -n "$IPA_FILE" ]; then
          echo "üì± Found IPA: $IPA_FILE"
          echo "üîë Using Fastlane Session Token"
          
          # Upload using Fastlane session with username
          fastlane run upload_to_app_store \
            ipa:"$IPA_FILE" \
            username:"dohrasanket@gmail.com" \
            skip_screenshots:true \
            skip_metadata:true \
            skip_app_version_update:true \
            force:true \
            precheck_include_in_app_purchases:false
            
          echo "‚úÖ Upload completed!"
        else
          echo "‚ö†Ô∏è No IPA found to upload"
        fi
      env:
        FASTLANE_SESSION: '---
- !ruby/object:HTTP::Cookie
  name: myacinfo
  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d3c240e5c432b5bf1f36da31bb243b5a6f6b19588183d854124812c0fff9049ef97c3bd29005797633c7fb29e0457e3f551626cc314b29ecae3bf6755abae3957bb22b3c07eaae22c2da5ab3d1c18e04f7ff609e27e63187702d70ae61258f4891a2e99c018899b57801e8978ef70ad521afacfee86fbbdcd7ade8d85eb9094d225bc7b2a9531ca2a87da8580c2f4605d00b0938bc7c4608899ca5128a0d0dc4ee77508a90d6fc87d040c5a2b1592299e55b800f0fa83756b453ec6e617a7419c06c2e7c974a90fb318bf065e04754dd10c9344970c67237b7fbb46f4dab2f931ab63e5755219c60f2c165ed5f55f14d9e068dc988238f883652aa9ed9efa1141251b0704719658eb7fe12c02b73c32f51d67d57da5946380358b953a082fdfb766eb43f539b7ca29f0da78353a09c1d2d717ad22484c3a49edae56239b16b2ada5ced3f13369f5fddca8ed09790531956bc43efbbf059c292f0bb199bdb61a511c05a4b8653ab9acd772eb22dd8add810de2543c835a683978421e977d92570d5d3c1b968d65e51ebbda86a98fdf3d00fec4de5a88104576b8be34569f7c594299e3c766189ea1232a9a733d907eb2907fb07f71b978087358dcfd65187ce898532090f72015e1e6ff2507bfc4387dfab4e2d63b487b894fc54c27d74e23ea3f6e905cba2a826858e8f625a09139f6f94c20cb74d4543601d800259ad7fc6e293585a47V3
  domain: apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires:
  max_age:
  created_at: 2025-10-13 10:33:23.730297000 +05:30
  accessed_at: 2025-10-13 14:17:51.627228000 +05:30
- !ruby/object:HTTP::Cookie
  name: DES521e216212c21f11a57fea7444394ae78
  value: HSARMTKNSRVXWFlaT2xBLF+Quc4blkCklk9hmyJARkstbGcBSuzM9C1BydSr5uYzKaWm5qX+VzcW7nRHSOXOegc3ZXJG+6vIg8ERyLZLOR5ZsOwVzwt/QfKVHUK8LlN0tCsXfp4ah+TKi73ddCfmY3dEFonCJ/BUwLOhipg78JXJUjtzZLIqXU0b1e31YWqFDw==SRVX
  domain: idmsa.apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires:
  max_age: 2592000
  created_at: 2025-10-10 11:30:12.666718000 +05:30
  accessed_at: 2025-10-13 10:33:21.039345000 +05:30
- !ruby/object:HTTP::Cookie
  name: dqsid
  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3NjAzNDUyNzEsImp0aSI6IlpSR01DYnNQWC1mVi1VRjFYcldtc3cifQ.jnN9TGWKbm_J93JWDzykZ_UHxWwWjkNkP3JD7YLwnfc
  domain: appstoreconnect.apple.com
  for_domain: false
  path: "/"
  secure: true
  httponly: true
  expires:
  max_age: 1800
  created_at: &1 2025-10-13 14:17:52.929326000 +05:30
  accessed_at: *1'
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
      continue-on-error: true
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: "xzwz-wtfs-wptw-bhhe"
