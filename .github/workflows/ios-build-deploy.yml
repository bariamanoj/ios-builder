name: iOS Auto Build and Deploy

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL'
        required: true
        type: string
      app_name:
        description: 'App name for App Store'
        required: true
        type: string
      bundle_identifier:
        description: 'Bundle identifier (e.g., com.company.app)'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.repo_url || 'bariamanoj/NewAppSample' }}
        token: ${{ secrets.GH_TOKEN }}
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0'
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    
    - name: Install Fastlane
      run: gem install fastlane

    - name: Generate Certificates with Fastlane
      run: |
        echo "🔐 Generating certificates with Fastlane"
        
        mkdir -p fastlane
        cat > fastlane/Fastfile << 'EOF'
        default_platform(:ios)

        platform :ios do
          desc "Build with automatic signing"
          lane :build_and_sign do
            # Build with automatic code signing (team already set in project)
            gym(
              configuration: "Release",
              export_method: "app-store",
              export_options: {
                method: "app-store",
                teamID: "42FLQUC3A9",
                uploadBitcode: false,
                uploadSymbols: true,
                signingStyle: "automatic"
              },
              output_directory: "./build/ipa",
              output_name: "ManzTestApp2025.ipa"
            )
          end
        end
        EOF
        
        # Create certs directory
        mkdir -p certs
        
        # Run Fastlane
        fastlane build_and_sign
        
      env:
        FASTLANE_SESSION: |
          ---
          - !ruby/object:HTTP::Cookie
            name: myacinfo
            value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d310a0dadf7c715e953ad1eed5ef11eac98285b7e4ce46d483139894ea5702a7f596beb9e172af8c071b38d57877acfc8968b8a5afca9e6a8ce7b8e27dd5a4b23a3b7e0f19a294ae74b89ece73d226a67de542d74b03ae434ad8776fd7aac41618f87fdb87933848a8f54cf9249231e4cf9c09ae3ba3bebd1ff66dd44f11e17e049ad840ebcf624bbea5030b895bfa364d98ebb36ea8e729355143eff6128afcb9bc8cd1a58187160605efa8d8c0c2fee3b24ff5d65b06b74c295f846fbd0b04a145bc4133c0495b9259446bfe6bd609a9ce86fea7231cbf438601fb4ebc88a312d2e4b9f56728a3bec998424adb23a33cb3ce49d1b16daf6f9c1e4cc101d67da26f6cd711bfa36f41b71f64b6d8e67cfdd62678edcd8a1a96d6b33c2005c4a6b80255a6704af4ee83662f9a17042ef2d7326039c29f45777a457e96f17b0398319a4b7a58509204b5141a23b1fbef934ab29f1a3dbc43a64b99b09c73bb208942ce99fcef795788ab749606914a3761c9c71b866fe17df959ec6c10b2682e05c0389ef0ca906d509965776435e55591940b61757b741c9d09847121a686ec64e0f46e83ec88bebe95967e6989a84d4d43626877683bfd2f7f1065fea66160f7838b3749c675a659d85a0aefc88da170f7b7a370942bfe7c495a901f04ffeb6c4862edcbf34c2b7e70f4100a8c6559cbc0de6bdb34eda5b368bbf0f60ca0107f2f585a47V3
            domain: apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires:
            max_age:
            created_at: 2025-10-14 10:17:21.846855000 +05:30
            accessed_at: 2025-10-14 10:17:21.848006000 +05:30
          - !ruby/object:HTTP::Cookie
            name: DES521e216212c21f11a57fea7444394ae78
            value: HSARMTKNSRVXWFlaT2xBLF+Quc4blkCklk9hmyJARkstbGcBSuzM9C1BydSr5uYzKaWm5qX+VzcW7nRHSOXOegc3ZXJG+6vIg8ERyLZLOR5ZsOwVzwt/QfKVHUK8LlN0tCsXfp4ah+TKi73ddCfmY3dEFonCJ/BUwLOhipg78JXJUjtzZLIqXU0b1e31YWqFDw==SRVX
            domain: idmsa.apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires:
            max_age: 2592000
            created_at: 2025-10-10 11:30:12.666718000 +05:30
            accessed_at: 2025-10-14 10:17:19.812593000 +05:30
          - !ruby/object:HTTP::Cookie
            name: dqsid
            value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3NjA0MTcyNDIsImp0aSI6IkxxRG5fR2RBT3hxQ2NnZHRLZ3NITUEifQ.2ILEREcsCBSIuAp8wPDEyUwaJl8_fH_xNG71K60KmYE
            domain: appstoreconnect.apple.com
            for_domain: false
            path: "/"
            secure: true
            httponly: true
            expires:
            max_age: 1800
            created_at: &1 2025-10-14 10:17:22.487443000 +05:30
            accessed_at: *1
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: "xzwz-wtfs-wptw-bhhe"
        MATCH_PASSWORD: "Welcome123"

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-${{ github.event.inputs.app_name || 'ManzTestApp2025' }}
        path: build/
        if-no-files-found: warn

    - name: Upload to TestFlight
      run: |
        echo "🚀 Uploading to TestFlight"
        
        IPA_FILE=$(find build/ipa -name "*.ipa" | head -1)
        
        if [ -n "$IPA_FILE" ]; then
          echo "📱 Found IPA: $IPA_FILE"
          
          fastlane run upload_to_testflight \
            ipa:"$IPA_FILE" \
            username:"dohrasanket@gmail.com" \
            skip_waiting_for_build_processing:true
            
          echo "✅ Upload completed!"
        else
          echo "⚠️ No IPA found to upload"
        fi
      env:
        FASTLANE_SESSION: |
          ---
          - !ruby/object:HTTP::Cookie
            name: myacinfo
            value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d310a0dadf7c715e953ad1eed5ef11eac98285b7e4ce46d483139894ea5702a7f596beb9e172af8c071b38d57877acfc8968b8a5afca9e6a8ce7b8e27dd5a4b23a3b7e0f19a294ae74b89ece73d226a67de542d74b03ae434ad8776fd7aac41618f87fdb87933848a8f54cf9249231e4cf9c09ae3ba3bebd1ff66dd44f11e17e049ad840ebcf624bbea5030b895bfa364d98ebb36ea8e729355143eff6128afcb9bc8cd1a58187160605efa8d8c0c2fee3b24ff5d65b06b74c295f846fbd0b04a145bc4133c0495b9259446bfe6bd609a9ce86fea7231cbf438601fb4ebc88a312d2e4b9f56728a3bec998424adb23a33cb3ce49d1b16daf6f9c1e4cc101d67da26f6cd711bfa36f41b71f64b6d8e67cfdd62678edcd8a1a96d6b33c2005c4a6b80255a6704af4ee83662f9a17042ef2d7326039c29f45777a457e96f17b0398319a4b7a58509204b5141a23b1fbef934ab29f1a3dbc43a64b99b09c73bb208942ce99fcef795788ab749606914a3761c9c71b866fe17df959ec6c10b2682e05c0389ef0ca906d509965776435e55591940b61757b741c9d09847121a686ec64e0f46e83ec88bebe95967e6989a84d4d43626877683bfd2f7f1065fea66160f7838b3749c675a659d85a0aefc88da170f7b7a370942bfe7c495a901f04ffeb6c4862edcbf34c2b7e70f4100a8c6559cbc0de6bdb34eda5b368bbf0f60ca0107f2f585a47V3
            domain: apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires:
            max_age:
            created_at: 2025-10-14 10:17:21.846855000 +05:30
            accessed_at: 2025-10-14 10:17:21.848006000 +05:30
          - !ruby/object:HTTP::Cookie
            name: DES521e216212c21f11a57fea7444394ae78
            value: HSARMTKNSRVXWFlaT2xBLF+Quc4blkCklk9hmyJARkstbGcBSuzM9C1BydSr5uYzKaWm5qX+VzcW7nRHSOXOegc3ZXJG+6vIg8ERyLZLOR5ZsOwVzwt/QfKVHUK8LlN0tCsXfp4ah+TKi73ddCfmY3dEFonCJ/BUwLOhipg78JXJUjtzZLIqXU0b1e31YWqFDw==SRVX
            domain: idmsa.apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires:
            max_age: 2592000
            created_at: 2025-10-10 11:30:12.666718000 +05:30
            accessed_at: 2025-10-14 10:17:19.812593000 +05:30
          - !ruby/object:HTTP::Cookie
            name: dqsid
            value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3NjA0MTcyNDIsImp0aSI6IkxxRG5fR2RBT3hxQ2NnZHRLZ3NITUEifQ.2ILEREcsCBSIuAp8wPDEyUwaJl8_fH_xNG71K60KmYE
            domain: appstoreconnect.apple.com
            for_domain: false
            path: "/"
            secure: true
            httponly: true
            expires:
            max_age: 1800
            created_at: &1 2025-10-14 10:17:22.487443000 +05:30
            accessed_at: *1
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: "xzwz-wtfs-wptw-bhhe"
        MATCH_PASSWORD: "Welcome123"
