name: iOS Auto Build and Deploy

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL'
        required: true
        type: string
      app_name:
        description: 'App name for App Store'
        required: true
        type: string
      bundle_identifier:
        description: 'Bundle identifier (e.g., com.company.app)'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.repo_url }}
        token: ${{ secrets.GH_TOKEN }}
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    
    - name: Install Fastlane
      run: gem install fastlane
    
    - name: Setup API Key
      run: |
        mkdir -p ~/.appstoreconnect/private_keys/
        echo "${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}.p8
        
        # Set up API key for Fastlane
        if [ -n "${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}" ]; then
          export FASTLANE_API_KEY_PATH="~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}.p8"
          export APP_STORE_CONNECT_API_KEY_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}"
          export APP_STORE_CONNECT_API_KEY_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}"
        fi
    
    - name: Create App on App Store Connect
      run: |
        echo "üçé Creating app on App Store Connect"
        
        # Use session token authentication (no 2FA needed)
        fastlane run produce \
          username:"dohrasanket@gmail.com" \
          app_name:"${{ github.event.inputs.app_name }}" \
          app_identifier:"${{ github.event.inputs.bundle_identifier }}" \
          language:"en-US" \
          app_version:"1.0" \
          sku:"$(echo "${{ github.event.inputs.bundle_identifier }}" | sed 's/\./-/g')-$(date +%s)" \
          skip_itc:false \
          skip_devcenter:false
      env:
        FASTLANE_SESSION: |
          ---
          - !ruby/object:HTTP::Cookie
            name: dslang
            value: US-EN
            domain: apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires: 
            max_age: 
            created_at: 2026-01-06 14:00:44.910393000 +05:30
            accessed_at: &1 2026-01-06 14:00:44.912573000 +05:30
          - !ruby/object:HTTP::Cookie
            name: site
            value: USA
            domain: apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires: 
            max_age: 
            created_at: 2026-01-06 14:00:44.910819000 +05:30
            accessed_at: *1
          - !ruby/object:HTTP::Cookie
            name: myacinfo
            value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d35f7d5e2c6c8b2a8ef1b8c0977e08e4b718de04aeaaa5c5b727699ca2e46fe6f957c90a68bc95ad36a9252f996ef13ec0a8b419dcf5c2895b0dd7db0709df2ac2956ba5ea00485f43e53970c022bb36eaf5174712d629773e0236688ac17824bfb8161913b4060a7222d4c4a59160b225134babc3fae9dfd8402b038af8b33d1f4ae5013ed93f31d4d5d2243f78ee8bb42bdcb30955d7874884c777f1bbd1a341868c8455d8bcccca22dca7c2289c43231f276f1639cb952237a5956f7a97a0af2326f4ba66401ea6046e3117b9fb34357e208eb422bffb9637a31ce803cdc0f29a1d9b6a141577c86c6194dd3bea728755b07b337a7d58f3cafa55cd0808ec6a9e87a6d4a7e884eb2e46399f3d7a415b09c6618bcec19876c45a4982f8aab58a989bfbd2a45a00eb1c41628ab2e77d365554cff0b01532983924efb6b0be53ad1f505e67d1cd9a588cccfdf00c60f2a8dcbbb1585d8b4982958b3647b7b47935b2eaadb0941b14f345e7be8409cb3ff4c782b34ac9927b26ade3eb87ddc459a3739834d7b5dcf2e9c5aab89f3a8006c28fb6d3d19b8aad8e32dd515f16c0fd16a3e4bbb317709c31f06d44675a4a0c2243bf48177123818fd2390a13f2ac6049bf2baed4bcf96c8dfa0622e22468eb2bab89da163b7b28c8c00729f9e58f9fafdc61a94b618431d774c427f6aa3b547584733e593b7034174d9bbdb0d57b5266585a47V3
            domain: apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires: 
            max_age: 
            created_at: 2026-01-06 14:00:44.911119000 +05:30
            accessed_at: *1
          - !ruby/object:HTTP::Cookie
            name: itctx
            value: eyJjcCI6ImIwYTcwMGJlLWY4ZmEtNDgxYy1iYjA3LTk5OTJhMmUyMDUyZCIsImRzIjoyMjU3MzM0ODU3MiwiZXgiOiIyMDI2LTEtNiAxNjozMDo0NSJ9|s54j5av06s2qgk31vmnsduckvf|bc17m1Z_9WC_hQFggU42yoITrWo
            domain: apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires: 
            max_age: 
            created_at: &2 2026-01-06 14:00:45.816395000 +05:30
            accessed_at: *2
          - !ruby/object:HTTP::Cookie
            name: itcdq
            value: "0"
            domain: apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: false
            expires: 
            max_age: 
            created_at: 2025-10-10 11:30:13.953707000 +05:30
            accessed_at: *1
          - !ruby/object:HTTP::Cookie
            name: aasp
            value: 5704F8F02EB63445DD7691DC7E43B06746FC08F2AB1DC9706B83B4E1558668F7DB655DA42E4069991E5F5323AEBB2A1974C94EEC91645AA8EDC1AA0D89E30581BCE13E3FC7487CD72002927C91177D8243591B3505335FCEB002B39373A25493A24EC888406E26FC9801EC8B5BB77C66B89CB54DC1B791D9
            domain: idmsa.apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires: 
            max_age: 
            created_at: 2026-01-06 14:00:43.518510000 +05:30
            accessed_at: &3 2026-01-06 14:00:43.527778000 +05:30
          - !ruby/object:HTTP::Cookie
            name: DES521e216212c21f11a57fea7444394ae78
            value: HSARMTKNSRVXWFlapWdIKltdYDCG0xxZGWYaYqyoFaL8OnDoCCe/ebc90ntQsZf8yy+zA5NvMvc8JOBeSUkZZOSnxvZvLCJtFy04TnOL4ZQ1xapiq+SvcbclMRe7hWNtjTKGLktsdV5C3/L/5B66xLik55YVBgfeVFh5dGksijfMSih22dcSKytj9icE9iANSRVX
            domain: idmsa.apple.com
            for_domain: true
            path: "/"
            secure: true
            httponly: true
            expires: 
            max_age: 2592000
            created_at: 2025-12-31 16:33:55.743577000 +05:30
            accessed_at: *3
          - !ruby/object:HTTP::Cookie
            name: dqsid
            value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3Njc2ODgyNDUsImp0aSI6Ilo2VzhsVXBWeEJCeGlSR3VJR1hEVUEifQ.aRfPP5GZ-1JY53wcFS3Ri_3XdLllQ5D2ExfhBw0z06M
            domain: appstoreconnect.apple.com
            for_domain: false
            path: "/"
            secure: true
            httponly: true
            expires: 
            max_age: 1800
            created_at: &4 2026-01-06 14:00:45.816041000 +05:30
            accessed_at: *4
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
      continue-on-error: true
    
    - name: Build and Create Archive
      run: |
        echo "üöÄ Creating iOS Archive"
        echo "üì¶ App: ${{ github.event.inputs.app_name }}"
        echo "üÜî Bundle: ${{ github.event.inputs.bundle_identifier }}"
        
        # Find project and build with xcodebuild
        if find . -maxdepth 1 -name "*.xcworkspace" -type d | grep -q .; then
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1 | sed 's|^\./||')
          SCHEME=$(basename "$WORKSPACE" .xcworkspace)
          echo "üì± Archiving workspace: $WORKSPACE"
          
          xcodebuild -workspace "$WORKSPACE" \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath "build/$SCHEME.xcarchive" \
                     CODE_SIGNING_ALLOWED=NO \
                     archive
            
        elif find . -maxdepth 1 -name "*.xcodeproj" -type d | grep -q .; then
          PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1 | sed 's|^\./||')
          SCHEME=$(basename "$PROJECT" .xcodeproj)
          echo "üì± Archiving project: $PROJECT"
          
          xcodebuild -project "$PROJECT" \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath "build/$SCHEME.xcarchive" \
                     CODE_SIGNING_ALLOWED=NO \
                     archive
        fi
        
        echo "‚úÖ Archive created successfully!"
        ls -la build/
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
    
    - name: Export IPA
      run: |
        echo "üì¶ Exporting IPA"
        
        # Find archive
        ARCHIVE=$(find build -name "*.xcarchive" | head -1)
        if [ -n "$ARCHIVE" ]; then
          echo "üì± Exporting from: $ARCHIVE"
          
          # Create IPA manually
          mkdir -p build/ipa
          
          # Extract app bundle from archive
          find "$ARCHIVE/Products/Applications" -name "*.app" -exec cp -r {} build/ipa/ \;
          
          cd build/ipa
          APP_FILE=$(find . -name "*.app" -type d | head -1 | sed 's|^\./||')
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -n "$APP_FILE" ]; then
            # Set build number to current timestamp to ensure uniqueness
            BUILD_NUMBER=$(date +%Y%m%d%H%M%S)
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$APP_FILE/Info.plist"
            echo "üì± Updated build number to: $BUILD_NUMBER"
            
            mkdir -p Payload
            mv "$APP_FILE" Payload/
            zip -r "$APP_NAME.ipa" Payload/
            rm -rf Payload/
            
            echo "‚úÖ IPA created successfully!"
            ls -la *.ipa
          else
            echo "‚ùå No .app bundle found"
          fi
        else
          echo "‚ùå No archive found to export"
        fi
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
    
    - name: Export IPA (Unsigned)
      run: |
        echo "üì¶ Exporting IPA"
        
        # Find archive
        ARCHIVE=$(find build -name "*.xcarchive" | head -1)
        if [ -n "$ARCHIVE" ]; then
          echo "üì± Exporting from: $ARCHIVE"
          
          # Create IPA manually
          mkdir -p build/ipa
          
          # Extract app bundle from archive
          find "$ARCHIVE/Products/Applications" -name "*.app" -exec cp -r {} build/ipa/ \;
          
          # Extract app bundle from archive
          find "$ARCHIVE/Products/Applications" -name "*.app" -exec cp -r {} build/ipa/ \;
          
          cd build/ipa
          APP_FILE=$(find . -name "*.app" -type d | head -1 | sed 's|^\./||')
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          if [ -n "$APP_FILE" ]; then
            # Set build number to current timestamp to ensure uniqueness
            BUILD_NUMBER=$(date +%Y%m%d%H%M%S)
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$APP_FILE/Info.plist"
            echo "üì± Updated build number to: $BUILD_NUMBER"
            
            mkdir -p Payload
            mv "$APP_FILE" Payload/
            zip -r "$APP_NAME.ipa" Payload/
            rm -rf Payload/
            
            echo "‚úÖ IPA created successfully!"
            ls -la *.ipa
          else
            echo "‚ùå No .app bundle found"
          fi
        else
          echo "‚ùå No archive found to export"
        fi
      continue-on-error: true
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-${{ github.event.inputs.app_name }}
        path: |
          build/
        if-no-files-found: warn
    
    - name: Create App on App Store Connect
      run: |
        echo "üèóÔ∏è Creating app on App Store Connect"
        
        # Run create_app directly (app already exists, will skip)
        fastlane create_app app_name:"${{ github.event.inputs.app_name }}" bundle_id:"${{ github.event.inputs.bundle_identifier }}" || echo "App may already exist, continuing..."
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
      continue-on-error: true

    - name: Configure App Store Pricing and Availability
      run: |
        echo "üí∞ Configuring App Store pricing and availability..."
        echo "üì± App: ${{ github.event.inputs.app_name }}"
        echo "üÜî Bundle: ${{ github.event.inputs.bundle_identifier }}"
        
        # Clone the latest ios-builder to get updated Fastfile
        cd /tmp
        rm -rf ios-builder
        git clone https://github.com/bariamanoj/ios-builder.git
        cd ios-builder
        
        # Install dependencies
        gem install fastlane spaceship
        
        # Run pricing configuration
        fastlane configure_pricing_and_availability bundle_id:"${{ github.event.inputs.bundle_identifier }}"
      env:
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
      continue-on-error: true

    - name: Upload to App Store Connect (Optional)
      run: |
        echo "üöÄ Attempting to upload to App Store Connect"
        
        # Find the IPA file from Fastlane build
        IPA_FILE=$(find build/ipa -name "*.ipa" | head -1)
        
        if [ -n "$IPA_FILE" ]; then
          echo "üì± Found IPA: $IPA_FILE"
          echo "üîë Using API key authentication"
          
          # Use upload_to_testflight with session token
          fastlane run upload_to_testflight \
            ipa:"$IPA_FILE" \
            username:"dohrasanket@gmail.com" \
            skip_waiting_for_build_processing:true
            
          echo "‚úÖ Upload completed!"
        else
          echo "‚ö†Ô∏è No IPA found to upload"
        fi
      env:
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        FASTLANE_PASSWORD: "Sanket_4392"
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: "xzwz-wtfs-wptw-bhhe"
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
      continue-on-error: true
