name: iOS Auto Build and Deploy

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL'
        required: true
        type: string
      app_name:
        description: 'App name for App Store'
        required: true
        type: string
      bundle_identifier:
        description: 'Bundle identifier (e.g., com.company.app)'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.repo_url }}
        token: ${{ secrets.GH_TOKEN }}
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    
    - name: Install Fastlane
      run: gem install fastlane
    
    - name: Build Archive (Skip App Creation)
      run: |
        echo "ðŸš€ iOS Build Pipeline Started"
        echo "App: ${{ github.event.inputs.app_name }}"
        echo "Bundle ID: ${{ github.event.inputs.bundle_identifier }}"
        echo "Repository: ${{ github.event.inputs.repo_url }}"
        echo ""
        
        mkdir -p fastlane
        cat > fastlane/Fastfile << 'FASTFILE_EOF'
        default_platform(:ios)
        
        platform :ios do
          desc "Build archive like local setup"
          lane :build_archive do
            puts "ðŸ”¨ Building iOS Archive..."
            
            # Find project files
            workspace_path = Dir.glob("*.xcworkspace").first
            project_path = Dir.glob("*.xcodeproj").first
            
            puts "Workspace: #{workspace_path}" if workspace_path
            puts "Project: #{project_path}" if project_path
            
            if workspace_path
              puts "ðŸ“± Building workspace: #{workspace_path}"
              build_app(
                workspace: workspace_path,
                scheme: File.basename(workspace_path, ".xcworkspace"),
                configuration: "Release",
                export_method: "app-store",
                skip_package_ipa: false,
                xcargs: "CODE_SIGNING_ALLOWED=NO"
              )
            elsif project_path
              puts "ðŸ“± Building project: #{project_path}"
              build_app(
                project: project_path,
                scheme: File.basename(project_path, ".xcodeproj"),
                configuration: "Release",
                export_method: "app-store",
                skip_package_ipa: false,
                xcargs: "CODE_SIGNING_ALLOWED=NO"
              )
            else
              UI.user_error!("âŒ No Xcode project found!")
            end
            
            puts "âœ… Archive created successfully!"
            puts "ðŸ“¦ App: #{ENV['APP_NAME']}"
            puts "ðŸ†” Bundle: #{ENV['BUNDLE_IDENTIFIER']}"
          end
        end
        FASTFILE_EOF
        
        fastlane build_archive
      env:
        FASTLANE_SKIP_2FA_UPGRADE: 1
        FASTLANE_HIDE_CHANGELOG: 1
        APP_NAME: ${{ github.event.inputs.app_name }}
        BUNDLE_IDENTIFIER: ${{ github.event.inputs.bundle_identifier }}
    
    - name: Upload Archive Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-archive
        path: |
          *.ipa
          *.xcarchive
        if-no-files-found: warn
