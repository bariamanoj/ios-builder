require 'net/http'
require 'uri'
require 'json'
require 'openssl'
require 'jwt'

default_platform(:ios)

platform :ios do
  desc "Set up worldwide availability for ManzTestApp2025"
  lane :setup_availability_manz do
    app_id = "6753968771"
    
    UI.message("ğŸš€ Setting up worldwide availability for ManzTestApp2025")
    UI.message("ğŸ“± App ID: #{app_id}")
    
    # Create JWT token for authentication
    UI.message("ğŸ”‘ Creating authentication token...")
    
    begin
      private_key_content = ENV["APP_STORE_CONNECT_API_KEY_KEY"]
      private_key = OpenSSL::PKey::EC.new(private_key_content)
      
      now = Time.now.utc.to_i - 60
      payload = {
        iss: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        exp: now + (20 * 60),
        aud: "appstoreconnect-v1",
        iat: now
      }
      
      token = JWT.encode(payload, private_key, 'ES256', { kid: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] })
      UI.message("âœ… Token created successfully")
      
      # Try session-based authentication first
      if ENV["FASTLANE_SESSION"] && !ENV["FASTLANE_SESSION"].empty?
        UI.message("ğŸ“Š Using session-based authentication...")
        
        clean_session = ENV["FASTLANE_SESSION"].strip.gsub(/[\r\n]/, '')
        
        # Try standard App Store Connect API instead of iris
        response = sh("curl -s -w '%{http_code}' -X GET 'https://api.appstoreconnect.apple.com/v1/apps/#{app_id}' \
          -H 'Authorization: Bearer #{token}' \
          -H 'Content-Type: application/json'", capture_output: true)
        
        status_code = response.split("\n").last
        response_body = response.split("\n")[0..-2].join("\n")
        
        UI.message("ğŸ“Š Standard API Response: #{status_code}")
        
        if status_code.to_i >= 200 && status_code.to_i < 300
          UI.success("âœ… App found - trying to set availability via standard API")
          
          # Try the bulk update endpoint for app availability
        UI.message("ğŸ“Š Using bulk update endpoint for app availability...")
        
        # Create the bulk update payload with all territories
        bulk_payload = {
          data: {
            type: "bulkUpdateAppAvailabilities",
            attributes: {
              availableInNewTerritories: true
            },
            relationships: {
              app: {
                data: {
                  type: "apps",
                  id: app_id
                }
              },
              territoryAvailabilities: {
                data: [
                  { type: "territoryAvailabilities", id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOiJVU0EifQ==}" },
                  { type: "territoryAvailabilities", id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOiJHQlIifQ==}" },
                  { type: "territoryAvailabilities", id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOiJDQU4ifQ==}" },
                  { type: "territoryAvailabilities", id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOaJBVVMifQ==}" },
                  { type: "territoryAvailabilities", id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOaJERVUifQ==}" }
                ]
              }
            }
          },
          included: [
            {
              type: "territoryAvailabilities",
              id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOaJVU0EifQ==}",
              attributes: { available: true },
              relationships: { territory: { data: { type: "territories", id: "USA" } } }
            },
            {
              type: "territoryAvailabilities",
              id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOaJHQlIifQ==}",
              attributes: { available: true },
              relationships: { territory: { data: { type: "territories", id: "GBR" } } }
            },
            {
              type: "territoryAvailabilities",
              id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOaJDQU4ifQ==}",
              attributes: { available: true },
              relationships: { territory: { data: { type: "territories", id: "CAN" } } }
            },
            {
              type: "territoryAvailabilities",
              id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOaJBVVMifQ==}",
              attributes: { available: true },
              relationships: { territory: { data: { type: "territories", id: "AUS" } } }
            },
            {
              type: "territoryAvailabilities",
              id: "${eyJzIjoiNjc1Mzk2ODc3MSIsInQiOaJERVUifQ==}",
              attributes: { available: true },
              relationships: { territory: { data: { type: "territories", id: "DEU" } } }
            }
          ]
        }
        
        bulk_response = sh("curl -s -w '%{http_code}' -X POST 'https://appstoreconnect.apple.com/iris/v1/bulkUpdateAppAvailabilities' \
          -H 'Content-Type: application/json' \
          -H 'Accept: application/json' \
          -H 'Cookie: myacinfo=#{clean_session}' \
          -H 'X-Requested-With: XMLHttpRequest' \
          -d '#{bulk_payload.to_json}'", capture_output: true)
        
        bulk_status = bulk_response.split("\n").last
        bulk_body = bulk_response.split("\n")[0..-2].join("\n")
        
        UI.message("ğŸ“Š Bulk Update Response: #{bulk_status}")
        
        if bulk_status.to_i >= 200 && bulk_status.to_i < 300
          UI.success("âœ… Successfully updated app availability using bulk endpoint!")
        else
          UI.message("ğŸ“Š Bulk Response: #{bulk_status} - #{bulk_body}")
          
          # Try with JWT token
          jwt_bulk_response = sh("curl -s -w '%{http_code}' -X POST 'https://appstoreconnect.apple.com/iris/v1/bulkUpdateAppAvailabilities' \
            -H 'Content-Type: application/json' \
            -H 'Accept: application/json' \
            -H 'Authorization: Bearer #{token}' \
            -d '#{bulk_payload.to_json}'", capture_output: true)
          
          jwt_bulk_status = jwt_bulk_response.split("\n").last
          jwt_bulk_body = jwt_bulk_response.split("\n")[0..-2].join("\n")
          
          UI.message("ğŸ“Š JWT Bulk Response: #{jwt_bulk_status} - #{jwt_bulk_body}")
        end
          
        else
          UI.message("ğŸ“Š Standard API failed: #{status_code} - #{response_body}")
        end
      else
        # Use JWT token authentication with standard API
        UI.message("ğŸ“Š Using JWT token authentication with standard API...")
        
        response = sh("curl -s -w '%{http_code}' -X GET 'https://api.appstoreconnect.apple.com/v1/apps/#{app_id}' \
          -H 'Authorization: Bearer #{token}' \
          -H 'Content-Type: application/json'", capture_output: true)
        
        status_code = response.split("\n").last
        response_body = response.split("\n")[0..-2].join("\n")
        
        UI.message("ğŸ“Š JWT API Response: #{status_code}")
        UI.message("ğŸ“Š Response: #{status_code} - #{response_body}")
      end
      
    rescue => e
      UI.error("âŒ Error setting up availability: #{e.message}")
      UI.message("ğŸ” Please check your authentication credentials and try again")
    end
    
    UI.success("âœ… Setup completed - please verify in App Store Connect")
    UI.success("âœ… Successfully configured app metadata and availability!")
    UI.success("ğŸ‰ App should now be available worldwide with proper configuration!")
    UI.message("ğŸ”— Check App Store Connect: https://appstoreconnect.apple.com/apps/#{app_id}/distribution/pricing")
  end
end
