default_platform(:ios)

platform :ios do
  desc "Build with Fastlane automatic provisioning"
  lane :build_and_sign do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
      duration: 1200,
      in_house: false
    )

    create_keychain(
      name: "fastlane_tmp_keychain",
      password: "temppassword123",
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    match(
      type: "appstore",
      app_identifier: "com.san.mainAp",
      git_url: "https://github.com/bariamanoj/ios-certificates-new",
      username: "dohrasanket@gmail.com",
      team_id: "42FLQUC3A9",
      readonly: false,
      keychain_name: "fastlane_tmp_keychain",
      keychain_password: "temppassword123"
    )

    update_project_provisioning(
      xcodeproj: "NewAppSample.xcodeproj",
      target_filter: "NewAppSample",
      profile: ENV["sigh_com.san.mainAp_appstore_profile-path"],
      code_signing_identity: "iPhone Distribution"
    )

    gym(
      configuration: "Release",
      export_method: "app-store",
      sdk: "iphoneos",
      export_options: {
        method: "app-store",
        teamID: "42FLQUC3A9",
        uploadBitcode: false,
        uploadSymbols: true,
        signingStyle: "manual"
      },
      output_directory: "./build/ipa",
      output_name: "#{ENV['APP_NAME'] || 'ManzTestApp2025'}_v1.1.ipa",
      archive_path: "./build/archive/#{ENV['APP_NAME'] || 'ManzTestApp2025'}_v1.1.xcarchive"
    )
  end

  desc "Set app to FREE in every country"
  lane :set_free_worldwide do
    require 'spaceship'

    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )

    app = Spaceship::ConnectAPI::App.find("com.san.mainAp")
    abort "App not found!" unless app

    price_schedule = app.get_app_price_schedule.first
    price_schedule ||= app.create_app_price_schedule(base_territory_id: "USA")

    free_tier = Spaceship::ConnectAPI::AppPriceTier.all.find { |t| t.price == 0.0 }
    abort "Free tier missing!" unless free_tier

    territories = Spaceship::ConnectAPI::Territory.all
    manual_prices = territories.map { |t| { territory_id: t.id, price_tier_id: free_tier.id } }

    price_schedule.patch(manual_prices: manual_prices)

    UI.success("FREE in #{territories.count} territories!")
  end
end
