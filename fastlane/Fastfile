default_platform(:ios)

platform :ios do
  desc "Build with Fastlane automatic provisioning"
  lane :build_and_sign do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
      duration: 1200,
      in_house: false
    )

    create_keychain(
      name: "fastlane_tmp_keychain",
      password: "temppassword123",
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    match(
      type: "appstore",
      app_identifier: "com.san.mainAp",
      git_url: "https://github.com/bariamanoj/ios-certificates-new",
      username: "dohrasanket@gmail.com",
      team_id: "42FLQUC3A9",
      readonly: false,
      keychain_name: "fastlane_tmp_keychain",
      keychain_password: "temppassword123"
    )

    update_project_provisioning(
      xcodeproj: "NewAppSample.xcodeproj",
      target_filter: "NewAppSample",
      profile: ENV["sigh_com.san.mainAp_appstore_profile-path"],
      code_signing_identity: "iPhone Distribution"
    )

    gym(
      configuration: "Release",
      export_method: "app-store",
      sdk: "iphoneos",
      export_options: {
        method: "app-store",
        teamID: "42FLQUC3A9",
        uploadBitcode: false,
        uploadSymbols: true,
        signingStyle: "manual"
      },
      output_directory: "./build/ipa",
      output_name: "#{ENV['APP_NAME'] || 'ManzTestApp2025'}_v1.1.ipa",
      archive_path: "./build/archive/#{ENV['APP_NAME'] || 'ManzTestApp2025'}_v1.1.xcarchive"
    )
  end

  desc "Upload to TestFlight and configure metadata + pricing"
  lane :upload_and_configure do |options|
    # Upload to TestFlight
    pilot(
      ipa: Dir.glob("./build/ipa/*.ipa").first,
      username: options[:contact_email] || "dohrasanket@gmail.com",
      app_identifier: "com.san.mainAp",
      skip_waiting_for_build_processing: true
    )

    # Upload metadata
    deliver(
      username: options[:contact_email] || "dohrasanket@gmail.com",
      app_identifier: "com.san.mainAp",
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true,
      description: { "en-US" => options[:app_description] || "This is a sample utility app." },
      name: { "en-US" => options[:app_name] || "ManzTestApp2025" },
      keywords: { "en-US" => "utility, free, app" },
      copyright: "© 2025 #{options[:app_name] || 'ManzTestApp2025'}",
      marketing_url: { "en-US" => options[:support_url] || "https://manzz.app" },
      privacy_url: { "en-US" => options[:privacy_policy_url] || "https://manzz.app/privacy" },
      support_url: { "en-US" => options[:support_url] || "https://manzz.app/support" },
      primary_category: "UTILITIES",
      app_review_information: {
        first_name: options[:contact_first_name] || "SANKETKUMAR",
        last_name: options[:contact_last_name] || "DOHRA",
        phone_number: options[:contact_phone] || "+91 9265171259",
        email_address: options[:contact_email] || "dohrasanket@gmail.com",
        notes: "Contact for #{options[:app_name] || 'ManzTestApp2025'}"
      },
      submission_information: {
        add_id_info_uses_idfa: false,
        content_rights_has_rights: true,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: true,
        export_compliance_contains_third_party_cryptography: false,
        export_compliance_contains_proprietary_cryptography: false,
        export_compliance_available_on_french_store: true
      }
    )

    # Set app to FREE in every country
    set_free_worldwide
  end

  desc "Set app to FREE in every country"
  lane :set_free_worldwide do
    require 'spaceship'

    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )

    app = Spaceship::ConnectAPI::App.find("com.san.mainAp")
    UI.user_error!("App not found!") unless app

    # Get or create price schedule
    price_schedule_resp = app.get_app_price_schedule
    price_schedule = price_schedule_resp.first

    unless price_schedule
      UI.message("Creating new price schedule...")
      base_territory = Spaceship::ConnectAPI::Territory.all.find { |t| t.currency == 'USD' }
      price_schedule = app.create_app_price_schedule(base_territory_id: base_territory.id)
    else
      UI.message("Using existing price schedule.")
    end

    # Free tier (Tier 0)
    free_tier = Spaceship::ConnectAPI::AppPriceTier.all.find { |t| t.price == 0.0 }
    UI.user_error!("Free price tier not found!") unless free_tier
    UI.message("Using Free Tier: #{free_tier.tier_stem}")

    # All territories
    territories = Spaceship::ConnectAPI::Territory.all
    UI.message("Found #{territories.count} territories")

    # Build manual prices
    manual_prices = territories.map do |t|
      { territory_id: t.id, price_tier_id: free_tier.id }
    end

    # Apply
    price_schedule.patch(manual_prices: manual_prices)

    UI.success("FREE in #{territories.count} territories!")
  end

  desc "Full pipeline: build → upload → configure"
  lane :full_deploy do |options|
    build_and_sign
    upload_and_configure(options)
  end
end