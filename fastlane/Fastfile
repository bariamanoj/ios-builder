require 'net/http'
require 'uri'
require 'json'
require 'openssl'
require 'jwt'

default_platform(:ios)

platform :ios do
  desc "Set up worldwide availability for ManzTestApp2025"
  lane :setup_availability_manz do
    app_id = "6753968771"
    
    UI.message("ğŸš€ Setting up worldwide availability for ManzTestApp2025")
    UI.message("ğŸ“± App ID: #{app_id}")
    
    # Create JWT token for authentication
    UI.message("ğŸ”‘ Creating authentication token...")
    
    begin
      private_key_content = ENV["APP_STORE_CONNECT_API_KEY_KEY"]
      private_key = OpenSSL::PKey::EC.new(private_key_content)
      
      now = Time.now.utc.to_i - 60
      payload = {
        iss: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        exp: now + (20 * 60),
        aud: "appstoreconnect-v1",
        iat: now
      }
      
      token = JWT.encode(payload, private_key, 'ES256', { kid: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] })
      UI.message("âœ… Token created successfully")
      
      # Check app availability using standard API
      response = sh("curl -s -w '%{http_code}' -X GET 'https://api.appstoreconnect.apple.com/v1/apps/#{app_id}/appAvailabilityV2' \
        -H 'Authorization: Bearer #{token}' \
        -H 'Content-Type: application/json'", capture_output: true)
      
      status_code = response.split("\n").last.gsub(/[^0-9]/, '')
      response_body = response.split("\n")[0..-2].join("\n")
      
      UI.message("ğŸ“Š AppAvailabilityV2 Response: #{status_code}")
      
      if status_code.to_i >= 200 && status_code.to_i < 300
        UI.success("âœ… Successfully retrieved app availability!")
        UI.message("ğŸ“Š Response: #{response_body}")
        
        if response_body.include?('"availableInNewTerritories" : false')
          UI.message("ğŸ”„ App availability is currently set to false")
          UI.message("ğŸ“‹ Current status: availableInNewTerritories = false")
          UI.message("ğŸ¯ This means the app is NOT automatically available in new territories")
          UI.message("ğŸ”§ To enable worldwide availability, you need to:")
          UI.message("   1. Go to App Store Connect: https://appstoreconnect.apple.com/apps/6753968771/distribution/pricing")
          UI.message("   2. Navigate to Pricing and Availability")
          UI.message("   3. Enable 'Make this app available in new territories'")
          UI.message("   4. Or manually select all territories where you want the app available")
          UI.success("âœ… App availability check completed - manual action required")
        else
          UI.success("âœ… App is already available in new territories!")
        end
      else
        UI.message("ğŸ“Š API failed: #{status_code} - #{response_body}")
      end
      
    rescue => e
      UI.error("âŒ Error setting up availability: #{e.message}")
      UI.message("ğŸ” Please check your authentication credentials and try again")
    end
    
    UI.success("âœ… Setup completed - please verify in App Store Connect")
    UI.message("ğŸ”— Check App Store Connect: https://appstoreconnect.apple.com/apps/#{app_id}/distribution/pricing")
  end
end
