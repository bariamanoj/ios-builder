default_platform(:ios)

platform :ios do
  desc "Build and archive iOS app"
  lane :build_archive do |options|
    app_name = options[:app_name] || "MyApp"
    bundle_id = options[:bundle_id] || "com.example.app"
    
    # Find project/workspace
    if Dir.glob("*.xcworkspace").any?
      workspace = Dir.glob("*.xcworkspace").first
      scheme = File.basename(workspace, ".xcworkspace")
      
      build_app(
        workspace: workspace,
        scheme: scheme,
        configuration: "Release",
        export_method: "app-store",
        archive_path: "./build/#{scheme}.xcarchive",
        output_directory: "./build/ipa",
        output_name: "#{app_name}.ipa"
      )
    elsif Dir.glob("*.xcodeproj").any?
      project = Dir.glob("*.xcodeproj").first
      scheme = File.basename(project, ".xcodeproj")
      
      build_app(
        project: project,
        scheme: scheme,
        configuration: "Release",
        export_method: "app-store",
        archive_path: "./build/#{scheme}.xcarchive",
        output_directory: "./build/ipa",
        output_name: "#{app_name}.ipa"
      )
    end
  end

  desc "Create app on App Store Connect"
  lane :create_app do |options|
    app_name = options[:app_name] || "MyApp"
    bundle_id = options[:bundle_id] || "com.example.app"
    
    produce(
      username: "dohrasanket@gmail.com",
      app_name: app_name,
      app_identifier: bundle_id,
      language: "en-US",
      app_version: "1.0",
      sku: bundle_id == "com.san.mainAp" ? "ManzTestApp2025" : "#{bundle_id.gsub('.', '-')}-#{Time.now.to_i}",
      skip_itc: false,
      skip_devcenter: false
    )
  end 

  desc "Upload IPA to App Store Connect"
  lane :upload_ipa do |options|
    ipa_path = options[:ipa_path] || Dir.glob("./build/ipa/*.ipa").first
    
    if ipa_path && File.exist?(ipa_path)
      upload_to_testflight(
        username: "dohrasanket@gmail.com",
        ipa: ipa_path,
        skip_waiting_for_build_processing: true
      )
    else
      UI.error("No IPA file found at #{ipa_path}")
    end
  end

  desc "Upload metadata to App Store Connect"
  lane :upload_metadata do |options|
    deliver(
      username: "dohrasanket@gmail.com",
      app_identifier: options[:bundle_id] || "com.san.mainAp",
      metadata_path: "./metadata",
      screenshots_path: "./screenshots",
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true,
      overwrite_screenshots: false,
      submit_for_review: false,
      automatic_release: false,
      skip_app_version_update: true,
      app_version: "1.0",
      copyright: "@ManzzPlusApp",
      primary_category: "UTILITIES",
      price_tier: 0,
      keywords: {
        "en-US" => "ManzzPlusApp"
      },
      description: {
        "en-US" => options[:description] || "ManzTestApp2025 - A utility application"
      },
      name: {
        "en-US" => options[:app_name] || "ManzTestApp2025"
      },
      support_url: {
        "en-US" => "https://manzz.app/support"
      },
      marketing_url: {
        "en-US" => "https://manzz.app"
      },
      privacy_url: {
        "en-US" => "https://manzz.app/privacy"
      },
      app_review_information: {
        contact_email: "dohrasanket@gmail.com",
        contact_first_name: "SANKETKUMAR",
        contact_last_name: "DOHRA",
        contact_phone: "+91 9265171259",
        demo_account_name: "",
        demo_account_password: "",
        notes: "Test app for ManzTestApp2025"
      },
      submission_information: {
        export_compliance_platform: "ios",
        export_compliance_compliance_required: false,
        export_compliance_encryption_updated: false,
        export_compliance_app_type: nil,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: true,
        export_compliance_contains_third_party_cryptography: false,
        export_compliance_contains_proprietary_cryptography: false,
        export_compliance_available_on_french_store: false
      }
    )
  end

  desc "Update privacy details"
  lane :update_privacy_details do
    require 'spaceship'
    
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )
    
    # Get app ID
    app = Spaceship::ConnectAPI::App.find("com.san.mainAp")
    
    # Privacy settings need to be configured manually in App Store Connect
    # as there's no direct API support for privacy data collection settings yet
    UI.important("Privacy data collection settings must be configured manually in App Store Connect:")
    UI.message("1. Go to App Store Connect > Your App > App Privacy")
    UI.message("2. Set 'Data Collection' to 'Yes, we collect data from this app'")
    UI.message("3. Add these data types:")
    UI.message("   - Identifiers > Device ID (Analytics, App Functionality, Linked to User, Used for Tracking)")
    UI.message("   - Usage Data (Analytics, App Functionality, Linked to User, Used for Tracking)")
    UI.message("   - Advertising Data (Analytics, App Functionality, Linked to User, Used for Tracking)")
  end

  desc "Configure Pricing (Free) and Availability (All Countries)"
  lane :configure_pricing_and_availability do |options|
    bundle_id = options[:bundle_id] || "com.san.mainAp"

    # Set fresh session token if not already set
    if ENV["FASTLANE_SESSION"].nil? || ENV["FASTLANE_SESSION"].empty?
      ENV["FASTLANE_SESSION"] = '---
- !ruby/object:HTTP::Cookie
  name: dslang
  value: US-EN
  domain: apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires: 
  max_age: 
  created_at: 2026-01-06 14:00:44.910393000 +05:30
  accessed_at: &1 2026-01-06 14:00:44.912573000 +05:30
- !ruby/object:HTTP::Cookie
  name: site
  value: USA
  domain: apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires: 
  max_age: 
  created_at: 2026-01-06 14:00:44.910819000 +05:30
  accessed_at: *1
- !ruby/object:HTTP::Cookie
  name: myacinfo
  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d35f7d5e2c6c8b2a8ef1b8c0977e08e4b718de04aeaaa5c5b727699ca2e46fe6f957c90a68bc95ad36a9252f996ef13ec0a8b419dcf5c2895b0dd7db0709df2ac2956ba5ea00485f43e53970c022bb36eaf5174712d629773e0236688ac17824bfb8161913b4060a7222d4c4a59160b225134babc3fae9dfd8402b038af8b33d1f4ae5013ed93f31d4d5d2243f78ee8bb42bdcb30955d7874884c777f1bbd1a341868c8455d8bcccca22dca7c2289c43231f276f1639cb952237a5956f7a97a0af2326f4ba66401ea6046e3117b9fb34357e208eb422bffb9637a31ce803cdc0f29a1d9b6a141577c86c6194dd3bea728755b07b337a7d58f3cafa55cd0808ec6a9e87a6d4a7e884eb2e46399f3d7a415b09c6618bcec19876c45a4982f8aab58a989bfbd2a45a00eb1c41628ab2e77d365554cff0b01532983924efb6b0be53ad1f505e67d1cd9a588cccfdf00c60f2a8dcbbb1585d8b4982958b3647b7b47935b2eaadb0941b14f345e7be8409cb3ff4c782b34ac9927b26ade3eb87ddc459a3739834d7b5dcf2e9c5aab89f3a8006c28fb6d3d19b8aad8e32dd515f16c0fd16a3e4bbb317709c31f06d44675a4a0c2243bf48177123818fd2390a13f2ac6049bf2baed4bcf96c8dfa0622e22468eb2bab89da163b7b28c8c00729f9e58f9fafdc61a94b618431d774c427f6aa3b547584733e593b7034174d9bbdb0d57b5266585a47V3
  domain: apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires: 
  max_age: 
  created_at: 2026-01-06 14:00:44.911119000 +05:30
  accessed_at: *1
- !ruby/object:HTTP::Cookie
  name: itctx
  value: eyJjcCI6ImIwYTcwMGJlLWY4ZmEtNDgxYy1iYjA3LTk5OTJhMmUyMDUyZCIsImRzIjoyMjU3MzM0ODU3MiwiZXgiOiIyMDI2LTEtNiAxNjozMDo0NSJ9|s54j5av06s2qgk31vmnsduckvf|bc17m1Z_9WC_hQFggU42yoITrWo
  domain: apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires: 
  max_age: 
  created_at: &2 2026-01-06 14:00:45.816395000 +05:30
  accessed_at: *2
- !ruby/object:HTTP::Cookie
  name: itcdq
  value: "0"
  domain: apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: false
  expires: 
  max_age: 
  created_at: 2025-10-10 11:30:13.953707000 +05:30
  accessed_at: *1
- !ruby/object:HTTP::Cookie
  name: aasp
  value: 5704F8F02EB63445DD7691DC7E43B06746FC08F2AB1DC9706B83B4E1558668F7DB655DA42E4069991E5F5323AEBB2A1974C94EEC91645AA8EDC1AA0D89E30581BCE13E3FC7487CD72002927C91177D8243591B3505335FCEB002B39373A25493A24EC888406E26FC9801EC8B5BB77C66B89CB54DC1B791D9
  domain: idmsa.apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires: 
  max_age: 
  created_at: 2026-01-06 14:00:43.518510000 +05:30
  accessed_at: &3 2026-01-06 14:00:43.527778000 +05:30
- !ruby/object:HTTP::Cookie
  name: DES521e216212c21f11a57fea7444394ae78
  value: HSARMTKNSRVXWFlapWdIKltdYDCG0xxZGWYaYqyoFaL8OnDoCCe/ebc90ntQsZf8yy+zA5NvMvc8JOBeSUkZZOSnxvZvLCJtFy04TnOL4ZQ1xapiq+SvcbclMRe7hWNtjTKGLktsdV5C3/L/5B66xLik55YVBgfeVFh5dGksijfMSih22dcSKytj9icE9iANSRVX
  domain: idmsa.apple.com
  for_domain: true
  path: "/"
  secure: true
  httponly: true
  expires: 
  max_age: 2592000
  created_at: 2025-12-31 16:33:55.743577000 +05:30
  accessed_at: *3
- !ruby/object:HTTP::Cookie
  name: dqsid
  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3Njc2ODgyNDUsImp0aSI6Ilo2VzhsVXBWeEJCeGlSR3VJR1hEVUEifQ.aRfPP5GZ-1JY53wcFS3Ri_3XdLllQ5D2ExfhBw0z06M
  domain: appstoreconnect.apple.com
  for_domain: false
  path: "/"
  secure: true
  httponly: true
  expires: 
  max_age: 1800
  created_at: &4 2026-01-06 14:00:45.816041000 +05:30
  accessed_at: *4'
    end

    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )

    UI.message("ğŸ” Finding app with bundle ID: #{bundle_id}")
    app = Spaceship::ConnectAPI::App.find(bundle_id)
    UI.user_error!("App with bundle ID #{bundle_id} not found") if app.nil?

    UI.success("âœ… Found app: #{app.name} (ID: #{app.id})")
    
    begin
      # Simple pricing configuration using produce action
      UI.message("ğŸ’° Setting app pricing to FREE ($0.00) for all countries...")
      
      # Use produce action to update app pricing only
      produce(
        app_identifier: bundle_id,
        price_tier: 0,
        skip_itc: true,
        skip_devcenter: true
      )
      
      UI.success("âœ… Pricing set to FREE for all countries")
      UI.success("ğŸ”— Verify at: https://appstoreconnect.apple.com/apps/#{app.id}/distribution/pricing")
      
    rescue => e
      UI.error("âŒ Automated pricing failed: #{e.message}")
      UI.important("ğŸ“‹ MANUAL CONFIGURATION REQUIRED:")
      UI.message("ğŸ”— Go to: https://appstoreconnect.apple.com/apps/#{app.id}/distribution/pricing")
      UI.message("")
      UI.message("ğŸª PRICING SETUP:")
      UI.message("   1. Click: Add Pricing")
      UI.message("   2. Base Country: United States (USD)")
      UI.message("   3. Price: $0.00 (Free)")
      UI.message("   4. Apply to all countries/regions")
      UI.message("")
      UI.message("ğŸŒ AVAILABILITY SETUP:")
      UI.message("   1. Click: Set Up Availability")
      UI.message("   2. Select: All Countries or Regions")
      UI.message("   3. Save changes")
    end
  end

  desc "Complete build and upload process"
  lane :build_and_upload do |options|
    build_archive(options)
    create_app(options)
    configure_pricing_and_availability(options)
    upload_ipa(options)
    upload_metadata(options)
  end
end