default_platform(:ios)

platform :ios do
  desc "Setup app availability for all countries - ManzTestApp2025"
  lane :setup_availability_manz do
    app_id = "6753968771"
    
    UI.message("üöÄ Setting up worldwide availability for ManzTestApp2025")
    UI.message("üì± App ID: #{app_id}")
    
    begin
      # Try to setup API key if compatible
      begin
        app_store_connect_api_key(
          key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
          issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
          key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
        )
        UI.message("‚úÖ API key setup successful")
      rescue => e
        UI.message("‚ö†Ô∏è API key setup failed, using alternative auth: #{e.message}")
      end
      
      # Use Fastlane's deliver action to set up app availability
      UI.message("üìä Using Fastlane deliver to configure app availability...")
      
      deliver(
        app_identifier: "com.san.mainAp",
        skip_binary_upload: true,
        skip_screenshots: true,
        skip_metadata: false,
        force: true,
        overwrite_screenshots: false,
        submit_for_review: false,
        automatic_release: false,
        skip_app_version_update: true,
        
        # App metadata that triggers availability setup
        app_version: "1.0",
        copyright: "¬© 2025 ManzzPlusApp",
        primary_category: "UTILITIES",
        secondary_category: "PRODUCTIVITY",
        
        # Pricing and availability
        price_tier: 0, # Free
        
        # Localized metadata for major territories
        name: {
          "en-US" => "ManzTestApp2025",
          "en-GB" => "ManzTestApp2025",
          "de-DE" => "ManzTestApp2025",
          "fr-FR" => "ManzTestApp2025",
          "ja" => "ManzTestApp2025",
          "en-AU" => "ManzTestApp2025",
          "en-CA" => "ManzTestApp2025"
        },
        
        description: {
          "en-US" => "ManzTestApp2025 - A comprehensive utility application designed to enhance your productivity and streamline your daily tasks.",
          "en-GB" => "ManzTestApp2025 - A comprehensive utility application designed to enhance your productivity and streamline your daily tasks.",
          "de-DE" => "ManzTestApp2025 - Eine umfassende Utility-Anwendung zur Steigerung Ihrer Produktivit√§t.",
          "fr-FR" => "ManzTestApp2025 - Une application utilitaire compl√®te con√ßue pour am√©liorer votre productivit√©.",
          "ja" => "ManzTestApp2025 - ÁîüÁî£ÊÄß„ÇíÂêë‰∏ä„Åï„Åõ„ÇãÂåÖÊã¨ÁöÑ„Å™„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÄÇ",
          "en-AU" => "ManzTestApp2025 - A comprehensive utility application designed to enhance your productivity and streamline your daily tasks.",
          "en-CA" => "ManzTestApp2025 - A comprehensive utility application designed to enhance your productivity and streamline your daily tasks."
        },
        
        keywords: {
          "en-US" => "utility,productivity,tools,manz,app",
          "en-GB" => "utility,productivity,tools,manz,app",
          "de-DE" => "dienstprogramm,produktivit√§t,werkzeuge,manz,app",
          "fr-FR" => "utilitaire,productivit√©,outils,manz,app",
          "ja" => "„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£,ÁîüÁî£ÊÄß,„ÉÑ„Éº„É´,manz,„Ç¢„Éó„É™",
          "en-AU" => "utility,productivity,tools,manz,app",
          "en-CA" => "utility,productivity,tools,manz,app"
        },
        
        release_notes: {
          "en-US" => "Initial release of ManzTestApp2025. Welcome to a new era of productivity!",
          "en-GB" => "Initial release of ManzTestApp2025. Welcome to a new era of productivity!",
          "de-DE" => "Erste Ver√∂ffentlichung von ManzTestApp2025. Willkommen in einer neuen √Ñra der Produktivit√§t!",
          "fr-FR" => "Version initiale de ManzTestApp2025. Bienvenue dans une nouvelle √®re de productivit√©!",
          "ja" => "ManzTestApp2025„ÅÆÂàùÂõû„É™„É™„Éº„Çπ„ÄÇÊñ∞„Åó„ÅÑÁîüÁî£ÊÄß„ÅÆÊôÇ‰ª£„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ",
          "en-AU" => "Initial release of ManzTestApp2025. Welcome to a new era of productivity!",
          "en-CA" => "Initial release of ManzTestApp2025. Welcome to a new era of productivity!"
        },
        
        support_url: {
          "en-US" => "https://manzz.app/support"
        },
        
        marketing_url: {
          "en-US" => "https://manzz.app"
        },
        
        privacy_url: {
          "en-US" => "https://manzz.app/privacy"
        },
        
        # App review information
        app_review_information: {
          contact_email: "dohrasanket@gmail.com",
          contact_first_name: "SANKETKUMAR",
          contact_last_name: "DOHRA",
          contact_phone: "+91 9265171259",
          demo_account_name: "",
          demo_account_password: "",
          notes: "ManzTestApp2025 - Utility application for productivity enhancement. Free app available worldwide."
        },
        
        # Submission information
        submission_information: {
          export_compliance_platform: "ios",
          export_compliance_compliance_required: false,
          export_compliance_encryption_updated: false,
          export_compliance_app_type: nil,
          export_compliance_uses_encryption: false,
          export_compliance_is_exempt: true,
          export_compliance_contains_third_party_cryptography: false,
          export_compliance_contains_proprietary_cryptography: false,
          export_compliance_available_on_french_store: false
        }
      )
      
      UI.success("‚úÖ Successfully configured app metadata and availability using Fastlane deliver!")
      UI.message("üéâ App should now be available worldwide with proper localization!")
      UI.message("üîó Check App Store Connect: https://appstoreconnect.apple.com/apps/#{app_id}/distribution/pricing")
      
    rescue => e
      UI.error("‚ùå Availability setup failed: #{e.message}")
      UI.message("üí° Please check App Store Connect manually")
    end
  end

  desc "Build and archive iOS app"
  lane :build_archive do |options|
    app_name = options[:app_name] || "MyApp"
    bundle_id = options[:bundle_id] || "com.example.app"
    
    # Find project/workspace
    if Dir.glob("*.xcworkspace").any?
      workspace = Dir.glob("*.xcworkspace").first
      scheme = File.basename(workspace, ".xcworkspace")
      
      build_app(
        workspace: workspace,
        scheme: scheme,
        configuration: "Release",
        export_method: "app-store",
        archive_path: "./build/#{scheme}.xcarchive",
        output_directory: "./build/ipa",
        output_name: "#{app_name}.ipa"
      )
    elsif Dir.glob("*.xcodeproj").any?
      project = Dir.glob("*.xcodeproj").first
      scheme = File.basename(project, ".xcodeproj")
      
      build_app(
        project: project,
        scheme: scheme,
        configuration: "Release",
        export_method: "app-store",
        archive_path: "./build/#{scheme}.xcarchive",
        output_directory: "./build/ipa",
        output_name: "#{app_name}.ipa"
      )
    end
  end

  desc "Complete build and upload process"
  lane :build_and_upload do |options|
    build_archive(options)
    setup_availability_manz
  end
end
