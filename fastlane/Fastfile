require 'net/http'
require 'uri'
require 'json'
require 'openssl'
require 'jwt'

default_platform(:ios)

platform :ios do
  desc "Set up worldwide availability for ManzTestApp2025"
  lane :setup_availability_manz do
    app_id = "6753968771"
    
    UI.message("ğŸš€ Setting up worldwide availability for ManzTestApp2025")
    UI.message("ğŸ“± App ID: #{app_id}")
    
    # Create JWT token for authentication
    UI.message("ğŸ”‘ Creating authentication token...")
    
    begin
      private_key_content = ENV["APP_STORE_CONNECT_API_KEY_KEY"]
      private_key = OpenSSL::PKey::EC.new(private_key_content)
      
      now = Time.now.utc.to_i - 60
      payload = {
        iss: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        exp: now + (20 * 60),
        aud: "appstoreconnect-v1",
        iat: now
      }
      
      token = JWT.encode(payload, private_key, 'ES256', { kid: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] })
      UI.message("âœ… Token created successfully")
      
      # Try session-based authentication first
      if ENV["FASTLANE_SESSION"] && !ENV["FASTLANE_SESSION"].empty?
        UI.message("ğŸ“Š Using session-based authentication...")
        
        clean_session = ENV["FASTLANE_SESSION"].strip.gsub(/[\r\n]/, '')
        
        # Simple curl command to set availability
        response = sh("curl -s -w '%{http_code}' -X POST 'https://appstoreconnect.apple.com/iris/v2/appAvailabilities' \
          -H 'Content-Type: application/json' \
          -H 'Accept: application/json' \
          -H 'Cookie: myacinfo=#{clean_session}' \
          -H 'X-Requested-With: XMLHttpRequest' \
          -d '{\"data\":{\"type\":\"appAvailabilities\",\"attributes\":{\"availableInNewTerritories\":true},\"relationships\":{\"app\":{\"data\":{\"type\":\"apps\",\"id\":\"#{app_id}\"}}}}}'", capture_output: true)
        
        status_code = response.split("\n").last
        response_body = response.split("\n")[0..-2].join("\n")
        
        UI.message("ğŸ“Š Session API Response: #{status_code}")
        
        if status_code.to_i >= 200 && status_code.to_i < 300
          UI.success("âœ… Successfully configured app availability!")
        elsif status_code.to_i == 409
          UI.success("âœ… App availability already configured!")
        else
          UI.message("ğŸ“Š Session Response: #{status_code} - #{response_body}")
          
          # Try with JWT token as fallback
          UI.message("ğŸ”„ Trying with JWT token authentication...")
          
          jwt_response = sh("curl -s -w '%{http_code}' -X POST 'https://appstoreconnect.apple.com/iris/v2/appAvailabilities' \
            -H 'Content-Type: application/json' \
            -H 'Accept: application/json' \
            -H 'Authorization: Bearer #{token}' \
            -d '{\"data\":{\"type\":\"appAvailabilities\",\"attributes\":{\"availableInNewTerritories\":true},\"relationships\":{\"app\":{\"data\":{\"type\":\"apps\",\"id\":\"#{app_id}\"}}}}}'", capture_output: true)
          
          jwt_status = jwt_response.split("\n").last
          jwt_body = jwt_response.split("\n")[0..-2].join("\n")
          
          UI.message("ğŸ“Š JWT Response: #{jwt_status} - #{jwt_body}")
        end
      else
        # Use JWT token authentication
        UI.message("ğŸ“Š Using JWT token authentication...")
        
        response = sh("curl -s -w '%{http_code}' -X POST 'https://appstoreconnect.apple.com/iris/v2/appAvailabilities' \
          -H 'Content-Type: application/json' \
          -H 'Accept: application/json' \
          -H 'Authorization: Bearer #{token}' \
          -d '{\"data\":{\"type\":\"appAvailabilities\",\"attributes\":{\"availableInNewTerritories\":true},\"relationships\":{\"app\":{\"data\":{\"type\":\"apps\",\"id\":\"#{app_id}\"}}}}}'", capture_output: true)
        
        status_code = response.split("\n").last
        response_body = response.split("\n")[0..-2].join("\n")
        
        UI.message("ğŸ“Š JWT API Response: #{status_code}")
        UI.message("ğŸ“Š Response: #{status_code} - #{response_body}")
      end
      
    rescue => e
      UI.error("âŒ Error setting up availability: #{e.message}")
      UI.message("ğŸ” Please check your authentication credentials and try again")
    end
    
    UI.success("âœ… Setup completed - please verify in App Store Connect")
    UI.success("âœ… Successfully configured app metadata and availability!")
    UI.success("ğŸ‰ App should now be available worldwide with proper configuration!")
    UI.message("ğŸ”— Check App Store Connect: https://appstoreconnect.apple.com/apps/#{app_id}/distribution/pricing")
  end
end
