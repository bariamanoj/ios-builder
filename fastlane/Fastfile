default_platform(:ios)

platform :ios do
  desc "Build with Fastlane automatic provisioning"
  lane :build_and_sign do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
      duration: 1200,
      in_house: false
    )
    
    create_keychain(
      name: "fastlane_tmp_keychain",
      password: "temppassword123",
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )
    
    match(
      type: "appstore",
      app_identifier: "com.san.mainAp",
      git_url: "https://github.com/bariamanoj/ios-certificates-new",
      username: "dohrasanket@gmail.com",
      team_id: "42FLQUC3A9",
      readonly: false,
      keychain_name: "fastlane_tmp_keychain",
      keychain_password: "temppassword123"
    )
    
    update_project_provisioning(
      xcodeproj: "NewAppSample.xcodeproj",
      target_filter: "NewAppSample",
      profile: ENV["sigh_com.san.mainAp_appstore_profile-path"],
      code_signing_identity: "iPhone Distribution"
    )
    
    gym(
      configuration: "Release",
      export_method: "app-store",
      sdk: "iphoneos",
      export_options: {
        method: "app-store",
        teamID: "42FLQUC3A9",
        uploadBitcode: false,
        uploadSymbols: true,
        signingStyle: "manual"
      },
      output_directory: "./build/ipa",
      output_name: "ManzTestApp2025_v1.1.ipa",
      archive_path: "./build/archive/ManzTestApp2025_v1.1.xcarchive"
    )
  end

  desc "Upload to TestFlight and configure metadata"
  lane :upload_and_configure do |options|
    # Upload to TestFlight
    pilot(
      ipa: Dir.glob("./build/ipa/*.ipa").first,
      username: options[:contact_email] || "dohrasanket@gmail.com",
      app_identifier: "com.san.mainAp",
      skip_waiting_for_build_processing: true
    )
    
    # Upload metadata
    deliver(
      username: options[:contact_email] || "dohrasanket@gmail.com",
      app_identifier: "com.san.mainAp",
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true,
      description: { "en-US" => options[:app_description] || "This ManzzPlusApp app is just simple, sample demo app where you can get lots of details and guide and tips, This app spedically design for you, so why are you waiting just download and enjoy it." },
      name: { "en-US" => options[:app_name] || "ManzTestApp2025" },
      keywords: { "en-US" => "utility, free, app" },
      copyright: "© 2025 #{options[:app_name] || 'ManzTestApp2025'}",
      marketing_url: { "en-US" => options[:support_url] || "https://dohrasanket.pages.dev/support" },
      privacy_url: { "en-US" => options[:privacy_policy_url] || "https://dohrasanket.pages.dev/PrivacyPolicy" },
      support_url: { "en-US" => options[:support_url] || "https://dohrasanket.pages.dev/support" },
      primary_category: "UTILITIES",
      app_review_information: {
        first_name: options[:contact_first_name] || "SANKETKUMAR",
        last_name: options[:contact_last_name] || "DOHRA",
        phone_number: options[:contact_phone] || "+91 9265171259",
        email_address: options[:contact_email] || "dohrasanket@gmail.com",
        notes: "Contact for #{options[:app_name] || 'ManzTestApp2025'}"
      },
      submission_information: {
        add_id_info_uses_idfa: false,
        content_rights_has_rights: true,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: true,
        export_compliance_contains_third_party_cryptography: false,
        export_compliance_contains_proprietary_cryptography: false,
        export_compliance_available_on_french_store: true
      }
    )
    
    UI.success("SUCCESS: Metadata uploaded! Set pricing manually in App Store Connect:")
    UI.message("1. Go to App Store Connect → Your App → Pricing and Availability")
    UI.message("2. Set Price Schedule to 'Free'")
    UI.message("3. Set Availability to 'All Countries and Regions'")
  end

  desc "Update privacy details"
  lane :update_privacy_details do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )
    
    UI.important("Privacy data collection settings uploaded via upload_app_privacy_details_to_app_store. Confirm manually if needed:")
    UI.message("1. Go to App Store Connect > Your App > App Privacy")
    UI.message("2. Set 'Data Collection' to 'Yes, we collect data from this app'")
    UI.message("3. Add these data types:")
    UI.message("   - Identifiers > Device ID (Analytics, App Functionality, Linked to User, Used for Tracking)")
    UI.message("   - Advertising Data (Analytics, App Functionality, Linked to User, Used for Tracking)")
  end
end
